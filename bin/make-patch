#!/bin/bash
# $@: Proto file names
# make-patch CgProto
function patchone() {
  local Proto="$1"
  if [[ "" != "$2" ]] ; then echo "" > ${Proto}-patched.ts ; fi
  if [[ $(diff -q ${Proto}.ts ${Proto}-patched.ts) ]] ; then
    cp ${Proto}.ts ${Proto}-patched.ts
    protoc -I . --ts_out=. ${Proto}.proto
    diff -patch ${Proto}.ts ${Proto}-patched.ts > ${Proto}.patch
    patch ${Proto}.ts < ${Proto}.patch
  else
    echo 'no diff' ${Proto}
  fi
}
function makepatch () {
  local force=""
  if [[ "$1" == "-f" ]] ; then force="$1"; shift; fi
  local names="$@"
  if [[ "${names}" == "" ]] ; then names=$(cd src/proto; ls *.proto); fi
  for p in $names ; do (cd src/proto; patchone "${p%.proto}" "$force"); done
}
makepatch "$@"